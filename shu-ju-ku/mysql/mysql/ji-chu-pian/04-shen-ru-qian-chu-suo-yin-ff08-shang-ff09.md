# 1.深入浅出索引（上）

## 1.1.概念介绍

![](/static/image/5456451184546343431354.jpg)

深度是从根节点数到它的叶节点，高度是从叶节点数到它的根节点。

高度和深度是相反的表示，深度是从上到下数的，而高度是从下往上数。

①结点：包含一个数据元素及若干指向子树分支的信息。

②结点的度：一个结点拥有子树的数目称为结点的度。

③叶子结点：也称为终端结点，没有子树的结点或者度为零的结点。

④分支结点：也称为非终端结点，度不为零的结点称为非终端结点。

⑤树的度：树中所有结点的度的最大值。

⑥结点的层次：从根结点开始，假设根结点为第1层，根结点的孩子结点为第2层，依此类推，如果某一个结点位于第L层，则其孩子结点位于第L+1层。

⑦树的深度：也称为树的高度，树中所有结点的层次最大值称为树的深度。

⑧有序树：如果树中各棵子树的次序是有先后次序，则称该树为有序树。

⑨无序树：如果树中各棵子树的次序没有先后次序，则称该树为无序树。

⑩森林：由m（m≥0）棵互不相交的树构成一片森林。如果把一棵非空的树的根结点删除，则该树就变成了一片森林，森林中的树由原来根结点的各棵子树构成

## 1.2.带着问题学习

**1.索引是如何工作的呢？**

**2.哈希表、有序数组和搜索树三种常见的索引模型是怎样使用的？**

**3.什么是页分裂、页合并？**

**4.哪些场景应该使用自增主键，而哪些场景不应该**

## 1.3.基本介绍

提到数据库索引，我想你并不陌生，在日常工作中会经常接触到。比如某一个 SQL 查询比较慢，分析完原因之后，你可能就会说“给某个字段加个索引吧”之类的解决方案。但到底什么是索引，索引又是如何工作的呢？今天就让我们一起来聊聊这个话题吧。

数据库索引的内容比较多，我分成了上下两篇文章。索引是数据库系统里面最重要的概念之一，所以我希望你能够耐心看完。在后面的实战文章中，我也会经常引用这两篇文章中提到的知识点，加深你对数据库索引的理解。

一句话简单来说，索引的出现其实就是为了提高数据查询的效率，就像书的目录一样。一本 500 页的书，如果你想快速找到其中的某一个知识点，在不借助目录的情况下，那我估计你可得找一会儿。同样，对于数据库的表而言，索引其实就是它的“目录”。

### **索引的常见模型**

索引的出现是为了提高查询效率，但是实现索引的方式却有很多种，所以这里也就引入了索引模型的概念。可以用于提高读写效率的数据结构很多，这里我先给你介绍三种常见、也比较简单的数据结构，它们分别是哈希表、有序数组和搜索树。

下面我主要从使用的角度，为你简单分析一下这三种模型的区别。

哈希表是一种以键 - 值（key-value）存储数据的结构，我们只要输入待查找的键即 key，就可以找到其对应的值即 Value。哈希的思路很简单，把值放在数组里，用一个哈希函数把 key 换算成一个确定的位置，然后把 value 放在数组的这个位置。

不可避免地，多个 key 值经过哈希函数的换算，会出现同一个值的情况。处理这种情况的一种方法是，拉出一个链表。

假设，你现在维护着一个身份证信息和姓名的表，需要根据身份证号查找对应的名字，这时对应的哈希索引的示意图如下所示：

![](/static/image/0c62b601afda86fe5d0fe57346ace957.png)

图中，User2 和 User4 根据身份证号算出来的值都是 N，但没关系，后面还跟了一个链表。假设，这时候你要查 ID\_card\_n2 对应的名字是什么，处理步骤就是：首先，将 ID\_card\_n2 通过哈希函数算出 N；然后，按顺序遍历，找到 User2。

**需要注意的是，图中四个 ID\_card\_n 的值并不是递增的，这样做的好处是增加新的 User 时速度会很快，只需要往后追加。但缺点是，因为不是有序的，所以哈希索引做区间查询的速度是很慢的。**

你可以设想下，如果你现在要找身份证号在\[ID\_card\_X, ID\_card\_Y\]这个区间的所有用户，就必须全部扫描一遍了。

所以，**哈希表这种结构适用于只有等值查询的场景**，比如 Memcached 及其他一些 NoSQL 引擎。

而**有序数组在等值查询和范围查询场景中的性能就都非常优秀。**还是上面这个根据身份证号查名字的例子，如果我们使用有序数组来实现的话，示意图如下所示：

bfc907a92f99cadf5493cf0afac9ca49.png

这里我们假设身份证号没有重复，这个数组就是按照身份证号递增的顺序保存的。这时候如果你要查 ID\_card\_n2 对应的名字，用二分法就可以快速得到，这个时间复杂度是 O\(log\(N\)\)。

同时很显然，这个索引结构支持范围查询。你要查身份证号在\[ID\_card\_X, ID\_card\_Y\]区间的 User，可以先用二分法找到 ID\_card\_X（如果不存在 ID\_card\_X，就找到大于 ID\_card\_X 的第一个 User），然后向右遍历，直到查到第一个大于 ID\_card\_Y 的身份证号，退出循环。

**如果仅仅看查询效率，有序数组就是最好的数据结构了。但是，在需要更新数据的时候就麻烦了，你往中间插入一个记录就必须得挪动后面所有的记录，成本太高。**

所以，**有序数组索引只适用于静态存储引擎，**比如你要保存的是 2017 年某个城市的所有人口信息，这类不会再修改的数据。

二叉搜索树也是课本里的经典数据结构了。还是上面根据身份证号查名字的例子，如果我们用二叉搜索树来实现的话，示意图如下所示：

04fb9d24065635a6a637c25ba9ddde68.png

**二叉搜索树的特点是：每个节点的左儿子小于父节点，父节点又小于右儿子。**这样如果你要查 ID\_card\_n2 的话，按照图中的搜索顺序就是按照 UserA -&gt;UserC -&gt;UserF -&gt;User2 这个路径得到。这个时间复杂度是 O\(log\(N\)\)。

当然为了维持 O\(log\(N\)\) 的查询复杂度，你就需要保持这棵树是平衡二叉树。为了做这个保证，更新的时间复杂度也是 O\(log\(N\)\)。

**树可以有二叉，也可以有多叉。多叉树就是每个节点有多个儿子，儿子之间的大小保证从左到右递增。二叉树是搜索效率最高的，但是实际上大多数的数据库存储却并不使用二叉树。其原因是，索引不止存在内存中，还要写到磁盘上。**

# 2.总结

1.索引的作用：提高数据查询效率

2.常见索引模型：哈希表、有序数组、搜索树

3.哈希表：键 - 值\(key - value\)。

4.哈希思路：把值放在数组里，用一个哈希函数把key换算成一个确定的位置，然后把value放在数组的这个位置

5.哈希冲突的处理办法：链表

6.哈希表适用场景：只有等值查询的场景

7.有序数组：按顺序存储。查询用二分法就可以快速查询，时间复杂度是：O\(log\(N\)\)

8.有序数组查询效率高，更新效率低

9.有序数组的适用场景：静态存储引擎。

10.二叉搜索树：每个节点的左儿子小于父节点，父节点又小于右儿子

11.二叉搜索树：查询时间复杂度O\(log\(N\)\)，更新时间复杂度O\(log\(N\)\)

12.数据库存储大多不适用二叉树，因为树高过高，会适用N叉树

13.InnoDB中的索引模型：B+Tree

14.索引类型：主键索引、非主键索引

主键索引的叶子节点存的是整行的数据\(聚簇索引\)，非主键索引的叶子节点内容是主键的值\(二级索引\)

15.主键索引和普通索引的区别：主键索引只要搜索ID这个B+Tree即可拿到数据。普通索引先搜索索引拿到主键值，再到主键索引树搜索一次\(回表\)

16.一个数据页满了，按照B+Tree算法，新增加一个数据页，叫做页分裂，会导致性能下降。空间利用率降低大概50%。当相邻的两个数据页利用率很低的时候会做数据页合并，合并的过程是分裂过程的逆过程。

17.从性能和存储空间方面考量，自增主键往往是更合理的选择。

思考题：

如果删除，新建主键索引，会同时去修改普通索引对应的主键索引，性能消耗比较大。

删除重建普通索引貌似影响不大，不过要注意在业务低谷期操作，避免影响业务。

## 2.1.问题

**1.回表只是普通索引才会有的吗？主键和数据放在同一个树中，根据主键查询的时候，就可以直接获得数据了。**

**那select \* from table where id＝xx**

**和select id from table where id＝xx的效率是一样的吗？（id是主键）**

这两个语句是都不用回表了，在“查找行”这个逻辑上是一样的，但是select \*要读和拷贝更多列到server,还要发送更多列给客户端，所以还是select id更快的。

**2.每一张表其实就是一个B+树，树结点的key值就是某一行的主键，value是该行的其他数据。新建索引就是新增一个B+树，查询不走索引就是遍历主B+树？**

每一个表是好几棵B+树

**3.“N叉树”的N值在MySQL中是可以被人工调整的么？**

可以按照调整key的大小的思路来说；

如果你能指出来5.6以后可以通过page大小来间接控制应该能加分吧

面试回答不能太精减，计算方法、前缀索引什么的一起上

**4.请问没有主键的表，有一个普通索引。怎么回表？**

没有主键的表，innodb会给默认创建一个Rowid做主键

**5.innodb B+树主键索引的叶子节点存的是什么？**

B+树的叶子节点是page （页），一个页里面可以存多个行。

**6.索引只能定位到page，page内部怎么去定位行数据？**

内部有个有序数组，二分法

