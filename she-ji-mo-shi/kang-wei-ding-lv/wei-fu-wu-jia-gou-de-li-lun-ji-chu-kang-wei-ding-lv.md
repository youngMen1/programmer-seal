## 微服务架构的理论基础 - 康威定律

### 概述 {#1}

关于微服务的介绍，可以参考[微服务那点事](https://yq.aliyun.com/articles/2764)。

微服务是最近非常火热的新概念，大家都在追，也都觉得很对，但是似乎没有很充足的理论基础说明这是正确的，给人的感觉是**不明觉厉**。前段时间看了Mike Amundsen[《远距离条件下的康威定律——分布式世界中实现团队构建》](https://yq.aliyun.com/go/articleRenderRedirect?url=http%3A%2F%2Fwww.infoq.com%2Fcn%2Fpresentations%2Fteam-building-implementation-in-distributed-world)（是Design RESTful API的作者）在InfoQ上的一个分享，觉得很有帮助，结合自己的一些思考，整理了该演讲的内容。

可能出乎很多人意料之外的一个事实是，微服务很多核心理念其实在半个世纪前的一篇文章中就被阐述过了，而且这篇文章中的很多论点在软件开发飞速发展的这半个世纪中竟然一再被验证，这就是[康威定律（Conway's Law）](https://yq.aliyun.com/go/articleRenderRedirect?url=http%3A%2F%2Fwww.melconway.com%2FHome%2FConways_Law.html)。

3fa834ea8c880a97d00f187f67962a8218b16f22.png

ad8ba09ed2350c2a8c2f067d80197e74aefcef8d.png

在康威的这篇文章中，最有名的一句话就是：

中文直译大概的意思就是：设计系统的组织，其产生的设计等同于组织之内、组织之间的沟通结构。看看下面的图片（来源于互联网，侵删），再想想Apple的产品、微软的产品设计，就能形象生动的理解这句话。

74ab78cb5db601e5db68adf61e6dc58f437df4e0.png

用通俗的说法就是：组织形式等同系统设计。

这里的系统按原作者的意思并不局限于软件系统。据说这篇文章最初投的哈佛商业评论，结果程序员屌丝的文章不入商业人士的法眼，无情被拒，康威就投到了一个编程相关的杂志，所以被误解为是针对软件开发的。最初这篇文章显然不敢自称定律（law），只是描述了作者自己的发现和总结。后来，在Brooks Law著名的人月神话中，引用这个论点，并将其“吹捧”成了现在我们熟知“康威定律”。

### 康威定律详细介绍 {#2}

Mike从他的角度归纳这篇论文中的其他一些核心观点，如下：

* 第一定律

  * Communication dictates design
  * 组织沟通方式会通过系统设计表达出来

* 第二定律

  * There is never enough time to do something right, but there is always enough time to do it over
  * 时间再多一件事情也不可能做的完美，但总有时间做完一件事情

* 第三定律

  * There is a homomorphism from the linear graph of a system to the linear graph of its design organization
  * 线型系统和线型组织架构间有潜在的异质同态特性

* 第四定律

  * The structures of large systems tend to disintegrate during development, qualitatively more so than with small systems
  * 大的系统组织总是比小系统更倾向于分解

#### 人是复杂社会动物 {#3}

* 第一定律

  * Communication dictates design
  * 组织沟通方式决定系统设计

组织的沟通和系统设计之间的紧密联系，在很多别的领域有类似的阐述。对于复杂的系统，聊设计就离不开聊人与人的沟通，解决好人与人的沟通问题，才能有一个好的系统设计。相信几乎每个程序员都读过的《人月神话》（1975年，感觉都是老古董了，经典的就是经得起时间考验）里面许多观点都和这句话有异曲同工之妙。

fb215be9fe9232ccda1fc8817b4af6e8da6abcd0.png

比如《人月神话》中最著名的一句话就是

Boss们都听到了吗？为了赶进度加程序员就像用水去灭油锅里的火一样（无奈大家还是前赴后继）。

为什么？人月神话也给出了很简洁的答案：沟通成本 = n\(n-1\)/2，沟通成本随着项目或者组织的人员增加呈指数级增长。是的，项目管理这个算法的复杂度是O\(n^2\)。举个例子

* 5个人的项目组，需要沟通的渠道是 5\*\(5–1\)/2 = 10
* 15个人的项目组，需要沟通的渠道是15\*\(15–1\)/2 = 105
* 50个人的项目组，需要沟通的渠道是50\*\(50–1\)/2 = 1,225
* 150个人的项目组，需要沟通的渠道是150\*\(150–1\)/2 = 11,175

所以知道为什么互联网创业公司都这么小了吧，必须小啊，不然等CEO和所有人讲一遍创业的想法后，风投的钱都烧完了。

Mike还举了一个非常有意思的理论，叫“Dunbar Number”，这是一个叫Dunbar（废话）生物学家在1992年最早提出来的。最初，他发现灵长类的大脑容量和其对应的族群大小有一定关联，进而推断出人类的大脑能维系的关系的一些有趣估计。举例来说

* 亲密（intimate）朋友: 5
* 信任（trusted）朋友: 15
* 酒肉（close）朋友: 35
* 照面（casual）朋友: 150

a63beac73c8d217c71aba36c4a6e270a3fa18603.png

#### 一口气吃不成胖子，先搞定能搞定的 {#4}

* 第二定律:

  * There is never enough time to do something right, but there is always enough time to do it over
  * 时间再多一件事情也不可能做的完美，但总有时间做完一件事情

Eric Hollnagel是敏捷开发社区的泰斗之一，在他《Efficiency-Effectiveness Trade Offs》 一书中解释了类似的论点。

654425008b3a53442a77f32068302b44b51a32da.png

系统越做越复杂，功能越来越多，外部市场的竞争越来越剧烈，投资人的期待越来越高。但人的智力是有上限的，即使再牛逼的人，融到钱再多也不一定招到足够多合适的人。对于一个巨复杂的系统，我们永远无法考虑周全。Eric认为，这个时候最好的解决办法竟然是——“破罐子破摔”。

其实我们在日常开发中也经常碰到。产品经理的需求太复杂了？适当忽略一些细节，先抓主线。产品经理的需求太多了？放弃一些功能。

据说Eric被一家航空公司请去做安全咨询顾问，复杂保证飞机飞行系统的稳定性和安全性。Eric认为做到安全有两种方式：

* 常规的安全指的是尽可能多的发现并消除错误的部分，达到绝对安全，这是理想。
* 另一种则是弹性安全，即使发生错误，只要及时恢复，也能正常工作，这是现实。

对于飞机这样的复杂系统，再牛逼的人也无法考虑到漏洞的方方面面，所以Eric建议放弃打造完美系统的想法，而是通过不断的试飞，发现问题，确保问题发生时，系统能自动复原即可，而不追求飞行系统的绝对正确和安全。

下面的图很好的解释了这个过程：

a7fab1b350cd8c03d5e9ddded183c7bda114c326.png

听着很耳熟不是吗？这不就是**持续集成**和敏捷开发吗？的确就是。

另一方面，这和互联网公司维护的分布式系统的弹性设计也是一个道理。对于一个分布式系统，我们几乎永远不可能找到并修复所有的bug，单元测试覆盖1000%也没有用，错误流淌在分布式系统的血液里。解决方法不是消灭这些问题，而是容忍这些问题，在问题发生时，能自动回复，微服务组成的系统，每一个微服务都可能挂掉，这是常态，我们只有有足够的冗余和备份即可。即所谓的**弹性设计（Resilience）**或者叫高可用设计（High Availability）。

#### 种瓜得瓜，做独立自治的字系统减少沟通成本 {#5}

* 第三定律

  * There is a homomorphism from the linear graph of a system to the linear graph of its design organization
  * 线型系统和线型组织架构间有潜在的异质同态特性

  3810f88633a55bdf59bb7757cedc827ab425538e.png

这是康威第一定律组织和设计间内在关系的一个具体应用。更直白的说，你想要什么样的系统，就搭建什么样的团队。如果你的团队分成前端团队，Java后台开发团队，DBA团队，运维团队，你的系统就会长成下面的样子：

f4c2d4a8f8390ca6be19b54a524c8272aced3e34.png

相反，如果你的系统是按照业务边界划分的，大家按照一个业务目标去把自己的模块做出小系统，小产品的话，你的大系统就会长成下面的样子，即微服务的架构

c827db7a12d730140d4c0e6947535e168902a73e.png

微服务的理念团队间应该是

**inter-operate, not integrate**

。inter-operate是定义好系统的边界和接口，在一个团队内全栈，让团队自治，原因就是因为如果团队按照这样的方式组建，将沟通的成本维持在系统内部，每个子系统就会更加内聚，彼此的依赖耦合能变弱，跨系统的沟通成本也就能降低。

